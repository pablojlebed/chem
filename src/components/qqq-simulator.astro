---
// Astro Component Frontmatter: No server-side logic needed for this pure client-side component.
// We are using CDN links for external dependencies (Tailwind, D3, FontAwesome).
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ICP-MS QQQ Simulator</title>
    <!-- Tailwind CSS and D3.js via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Google Fonts for a scientific look -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght&display=swap"
      rel="stylesheet"
    />
    <!-- FontAwesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="p-4 md:p-8 max-w-7xl mx-auto">
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f1f5f9;
        color: #334155;
      }

      /* Dashboard Card Styling */
      .dash-card {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .dash-header {
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem 0.5rem 0 0;
        font-weight: 700;
        color: #475569;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .dash-body {
        padding: 1rem;
      }

      /* Chart Styling */
      .axis-label {
        font-size: 12px;
        font-weight: 600;
        fill: #64748b;
        font-family: "Inter", sans-serif;
      }
      .tick text {
        font-size: 11px;
        fill: #94a3b8;
        font-family: "Roboto Mono", monospace;
      }

      .grid-line {
        stroke: #e2e8f0;
        stroke-width: 1px;
        stroke-dasharray: 4;
      }

      /* Slider Base Styling */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
        cursor: pointer;
      }
      input[type="range"]:focus {
        outline: none;
      }

      /* Webkit Slider Track & Thumb */
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 6px;
        cursor: pointer;
        background: #e2e8f0;
        border-radius: 3px;
      }
      input[type="range"]::-webkit-slider-thumb {
        height: 18px;
        width: 18px;
        border-radius: 50%;
        background: #ffffff;
        border: 2px solid #cbd5e1;
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.15s ease;
      }
      input[type="range"]:active::-webkit-slider-thumb {
        transform: scale(1.1);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }

      /* Specific Slider Colors */
      .slider-analyte::-webkit-slider-thumb {
        border-color: #10b981;
      } /* Green */
      .slider-interf-0::-webkit-slider-thumb {
        border-color: #f59e0b;
      } /* Amber */
      .slider-interf-1::-webkit-slider-thumb {
        border-color: #ef4444;
      } /* Red */
      .slider-he::-webkit-slider-thumb {
        border-color: #8b5cf6;
        background: #f3e8ff;
      } /* Purple */
      .slider-he::-webkit-slider-runnable-track {
        background: linear-gradient(to right, #e2e8f0, #d8b4fe);
      }
      .slider-o2::-webkit-slider-thumb {
        border-color: #3b82f6;
        background: #eff6ff;
      } /* Blue */
      .slider-o2::-webkit-slider-runnable-track {
        background: linear-gradient(to right, #e2e8f0, #93c5fd);
      }

      /* Table Styling */
      .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.875rem;
      }
      .data-table th {
        background: #f8fafc;
        font-weight: 600;
        text-align: left;
        padding: 0.75rem 1rem;
        border-bottom: 2px solid #e2e8f0;
        color: #475569;
      }
      .data-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
        font-family: "Roboto Mono", monospace;
      }
      .data-table tr:last-child td {
        border-bottom: none;
        font-weight: 700;
        background-color: #f8fafc;
      }
      .status-badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        font-family: "Inter", sans-serif;
      }
    </style>

    <!-- Header -->
    <header
      class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4"
    >
      <div>
        <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">
          ICP-MS QQQ Simulator
        </h1>
        <p class="text-slate-500 mt-1">Interference Management</p>
      </div>

      <!-- Mode Selector -->
      <div
        class="bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex items-center gap-4"
      >
        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider"
          >Detector Mode</span
        >

        <label class="inline-flex items-center">
          <input
            type="radio"
            name="mode"
            value="Q1_CRC"
            checked
            onchange="updateMode(false)"
            class="form-radio text-indigo-600 h-4 w-4"
          />
          <span class="ml-2 text-sm text-slate-700 font-medium"
            >CRC/Q1 Mode</span
          >
        </label>
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="mode"
            value="MS_MS"
            onchange="updateMode(true)"
            class="form-radio text-indigo-600 h-4 w-4"
          />
          <span class="ml-2 text-sm text-slate-700 font-medium"
            >MS/MS Mode (Q1 → Q3)</span
          >
        </label>
      </div>
    </header>

    <!-- Tuning & Scenario Inputs -->
    <div
      class="mb-8 p-4 bg-white rounded-lg border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between"
    >
      <!-- Q1 Precursor Input -->
      <div class="flex items-center gap-2">
        <span id="q1-label" class="text-sm font-bold text-slate-600"
          >Q1 Precursor m/z:</span
        >
        <input
          type="number"
          id="target-mz"
          value="78"
          min="1"
          max="250"
          class="w-20 p-1 bg-slate-50 border border-slate-300 rounded text-center font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none"
        />
        <button
          id="load-btn"
          class="bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold py-2 px-4 rounded transition"
          >LOAD SCENARIO</button
        >
      </div>

      <!-- Q3 Product Input (Conditional) -->
      <div id="q3-input-group" class="hidden items-center gap-2">
        <span class="text-sm font-bold text-slate-600">Q3 Product m/z:</span>
        <input
          type="number"
          id="q3-mz"
          value="94"
          min="1"
          max="250"
          class="w-20 p-1 bg-slate-50 border border-slate-300 rounded text-center font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none"
        />
      </div>

      <span
        id="scenario-tag"
        class="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded"
        >No Scenario Loaded</span
      >
    </div>

    <!-- Error Message -->
    <div
      id="error-box"
      class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r"
    >
      <p class="text-red-700 font-bold text-sm">
        Scenario not found in database.
      </p>
      <p class="text-red-600 text-xs mt-1">Supported m/z: 56, 75, 78</p>
    </div>

    <!-- Main Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- LEFT COL: Chart (8 cols) -->
      <div class="lg:col-span-8 flex flex-col gap-6">
        <!-- Spectrum Visualizer -->
        <div class="dash-card">
          <div class="dash-header">
            <span id="chart-header">Mass Spectrum Simulation (CRC/Q1 Mode)</span
            >
            <span
              id="chart-range"
              class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-mono"
              >Mass Range: 77.2 to 78.8</span
            >
          </div>
          <div class="dash-body relative">
            <svg id="chart-canvas" class="w-full h-80"></svg>
            <!-- Floating Legend -->
            <div
              class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm p-3 rounded border border-slate-100 shadow-sm text-xs space-y-2"
            >
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-emerald-500"></div><span
                  class="font-medium text-slate-600">Analyte</span
                >
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-amber-500"></div><span
                  class="font-medium text-slate-600">Interferent 1</span
                >
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500"></div><span
                  class="font-medium text-slate-600">Interferent 2</span
                >
              </div>
              <div class="flex items-center gap-2">
                <div class="w-3 h-1 border-b-2 border-dashed border-blue-600">
                </div><span class="font-medium text-slate-600"
                  >Total Signal</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- CONTROLS ROW -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- 1. Sample Composition (Dynamic Inputs) -->
          <div class="dash-card">
            <div class="dash-header border-l-4 border-l-orange-400">
              <span>1. Sample Composition (Precursors in Plasma)</span>
              <i class="fa-solid fa-flask text-orange-400"></i>
            </div>
            <div class="dash-body bg-orange-50/30" id="composition-controls">
              <!-- Dynamic Sliders Injected Here -->
              <div class="text-sm text-slate-400 text-center py-4">
                Load a scenario to see controls
              </div>
            </div>
          </div>

          <!-- 2. Collision/Reaction Cell (CRC) Tuning -->
          <div class="dash-card">
            <div class="dash-header border-l-4 border-l-blue-600">
              <span>2. Collision/Reaction Cell (CRC) Tuning</span>
              <i class="fa-solid fa-sliders text-blue-600"></i>
            </div>
            <div class="dash-body space-y-6">
              <!-- Helium -->
              <div>
                <div class="flex justify-between items-center mb-1">
                  <label
                    class="text-xs font-bold text-slate-600 uppercase tracking-wide"
                    >Helium Flow (KED)</label
                  >
                  <span
                    id="val-he"
                    class="font-mono text-xs font-bold text-purple-600 bg-purple-50 px-2 py-0.5 rounded"
                    >0.0 mL/min</span
                  >
                </div>
                <input
                  type="range"
                  id="he-slider"
                  class="slider-he"
                  min="0"
                  max="10"
                  step="0.1"
                  value="0"
                />
                <p class="text-[10px] text-slate-400 mt-1">
                  Physical filter (KED). Removes large polyatomic ions.
                </p>
              </div>
              <!-- Oxygen -->
              <div>
                <div class="flex justify-between items-center mb-1">
                  <label
                    class="text-xs font-bold text-slate-600 uppercase tracking-wide"
                    >Oxygen Flow (Reaction)</label
                  >
                  <span
                    id="val-o2"
                    class="font-mono text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded"
                    >0 %</span
                  >
                </div>
                <input
                  type="range"
                  id="o2-slider"
                  class="slider-o2"
                  min="0"
                  max="100"
                  step="1"
                  value="0"
                />
                <p class="text-[10px] text-slate-400 mt-1">
                  Chemical filter. Used for mass shift (MS/MS) or removal
                  (CRC/Q1).
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COL: Data Table (4 cols) -->
      <div class="lg:col-span-4">
        <div class="dash-card h-full">
          <div class="dash-header">
            <span>Quantitative Analysis (Final Signal)</span>
          </div>
          <div class="dash-body p-0">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Ion Species</th>
                  <th class="text-right">Counts</th>
                  <th class="text-right">%</th>
                </tr>
              </thead>
              <tbody id="table-body">
                <!-- Rows injected via JS -->
              </tbody>
            </table>

            <div class="p-4 mt-4 bg-slate-50 border-t border-slate-100">
              <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">
                Interference Status
              </h4>
              <div
                id="status-message"
                class="text-sm font-medium text-slate-700"
              >
                <!-- Dynamic Status -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Client-Side JavaScript Logic -->
    <script is:inline>
      (function () {
        // --- CONFIGURATION ---
        const colors = {
          analyte: "#10b981", // Emerald 500
          interferents: ["#f59e0b", "#ef4444", "#8b5cf6"], // Amber, Red, Purple
          total: "#2563eb", // Blue 600
          grid: "#e2e8f0",
        };

        let currentScenario;
        let svg, g, x, y, line, area; // Added 'area'
        let width, height;
        const resolution_sigma = 0.05;
        let isMSMSMode = false;

        // --- DATABASE ---
        /* kedFactor: 0-1 (1 = removed easily by size)
           reactionFactor: 0-1 (1 = removed easily by O2 chemistry)
           productShift: Mass shift for O2 reaction in MS/MS mode (e.g., +16 for M+ -> MO+)
        */
        const database = {
          "56": {
            // Analyte: 56Fe+ (Precursor)
            analyte: {
              name: "56Fe+",
              mass: 56.0,
              kedLoss: 0.05,
              rxnLoss: 0.95,
              productShift: 16.0,
            }, // Fe reacts with O2 -> FeO (mass 72)
            interferents: [
              {
                name: "40Ar16O+",
                mass: 55.95,
                default: 500000,
                kedFactor: 0.8,
                reactionFactor: 0.1,
                productShift: 0.0,
              },
            ],
          },
          "75": {
            // Analyte: 75As+ (Precursor)
            analyte: {
              name: "75As+",
              mass: 75.0,
              kedLoss: 0.05,
              rxnLoss: 0.9,
              productShift: 16.0,
            }, // As reacts -> AsO (mass 91)
            interferents: [
              {
                name: "40Ar35Cl+",
                mass: 74.95,
                default: 200000,
                kedFactor: 0.85,
                reactionFactor: 0.05,
                productShift: 0.0,
              },
            ],
          },
          // SHOWCASE SCENARIO
          "78": {
            // Analyte: 78Se+ (Precursor)
            analyte: {
              name: "78Se+",
              mass: 78.0,
              kedLoss: 0.05,
              rxnLoss: 0.05, // Se is relatively inert, but we force reaction in MS/MS
              productShift: 16.0, // Se reacts with O2 -> SeO+ (mass 94)
            },
            interferents: [
              {
                name: "40Ar38Ar+ (Argon Dimer)",
                mass: 78.05,
                default: 400000,
                kedFactor: 0.95, // KED is excellent
                reactionFactor: 0.0, // Inert noble gas
                productShift: 0.0, // Remains at precursor mass
              },
              {
                name: "156Gd++ (Doubly Charged)",
                mass: 77.95,
                default: 150000,
                kedFactor: 0.1, // KED fails
                reactionFactor: 0.95, // Highly reactive metal, O2 removes/shifts easily
                productShift: 16.0, // Assume it forms GdO++ (mass 94) or is removed. For MS/MS complexity, let's allow it to shift to show potential issues.
              },
            ],
          },
        };

        // --- UI MODE TOGGLE ---

        window.updateMode = function (isMSMS) {
          isMSMSMode = isMSMS;
          document
            .getElementById("q3-input-group")
            .classList.toggle("hidden", !isMSMS);

          // Update labels based on mode
          document.getElementById("q1-label").textContent = "Q1 Precursor m/z:";
          document.getElementById("chart-header").textContent = isMSMS
            ? "Mass Spectrum Simulation (MS/MS Mode)"
            : "Mass Spectrum Simulation (CRC/Q1 Mode)";

          // Reload the scenario to reset the chart and calculations
          loadScenarioFromInput();
        };

        // --- CORE FUNCTIONS ---

        function init() {
          // Setup D3 Chart Dimensions (handled by resize listener on window)
          window.addEventListener("resize", resizeChart);

          // Event Listeners
          document
            .getElementById("load-btn")
            .addEventListener("click", loadScenarioFromInput);
          document
            .getElementById("q3-mz")
            .addEventListener("input", updateState);

          const heSlider = document.getElementById("he-slider");
          const o2Slider = document.getElementById("o2-slider");

          // --- MUTUAL EXCLUSION LOGIC ---
          const handleTuningInput = () => {
            const heFlow = parseFloat(heSlider.value);
            const o2Flow = parseFloat(o2Slider.value);

            if (heFlow > 0 && o2Flow > 0) {
              // Prevent both being active: prioritize the last one moved
              if (document.activeElement === heSlider) {
                o2Slider.value = 0;
              } else if (document.activeElement === o2Slider) {
                heSlider.value = 0;
              }
            }
            updateState();
          };

          heSlider.addEventListener("input", handleTuningInput);
          o2Slider.addEventListener("input", handleTuningInput);
          // ----------------------------------------

          // Load Default
          loadScenario("78");
        }

        function resizeChart() {
          const container = document.getElementById("chart-canvas");
          const rect = container.getBoundingClientRect();
          const margin = { top: 20, right: 30, bottom: 40, left: 60 };
          width = rect.width - margin.left - margin.right;
          height = rect.height - margin.top - margin.bottom;

          svg = d3.select("#chart-canvas");
          svg.attr("width", rect.width).attr("height", rect.height);
          // Clear existing elements before re-rendering
          g = svg.select("g");
          if (g.empty()) {
            g = svg
              .append("g")
              .attr("transform", `translate(${margin.left},${margin.top})`);
          } else {
            g.attr("transform", `translate(${margin.left},${margin.top})`);
          }

          x = d3.scaleLinear().range([0, width]);
          y = d3.scaleLinear().range([height, 0]);

          // LINE Generator (for the peak outline)
          line = d3
            .line()
            .x((d) => x(d.mz))
            .y((d) => y(d.intensity))
            .curve(d3.curveBasis);

          // AREA Generator (for the peak fill)
          area = d3
            .area()
            .x((d) => x(d.mz))
            .y0(height) // Baseline is the bottom of the chart
            .y1((d) => y(d.intensity))
            .curve(d3.curveBasis);

          if (currentScenario) {
            updateState();
          }
        }

        function loadScenarioFromInput() {
          const val = document.getElementById("target-mz").value;
          loadScenario(val);
        }

        function loadScenario(mz) {
          if (!database[mz]) {
            document.getElementById("error-box").classList.remove("hidden");
            return;
          }
          document.getElementById("error-box").classList.add("hidden");

          currentScenario = JSON.parse(JSON.stringify(database[mz])); // Deep copy
          currentScenario.q1Mz = parseFloat(mz);

          // Set default Q3 mass if in MS/MS mode (e.g., precursor + 16 for M -> MO)
          const defaultQ3 =
            currentScenario.q1Mz + currentScenario.analyte.productShift;
          document.getElementById("q3-mz").value = defaultQ3.toFixed(0);

          // Update Header Tag
          document.getElementById("scenario-tag").textContent =
            `Q1 Precursor: ${currentScenario.analyte.name}`;

          // Reset Tuning Sliders
          document.getElementById("he-slider").value = 0;
          document.getElementById("o2-slider").value = 0;

          renderInterferentControls();
          resizeChart(); // Recalculate dimensions and update state
        }

        function getStatusColor(data) {
          const totalInterf = data.interferents.reduce(
            (a, b) => a + b.finalCounts,
            0
          );
          const analyte = data.analyte.finalCounts;
          const snr = analyte / (totalInterf + 1);

          if (snr > 20) {
            return "#d1fae5"; // Light green (Emerald 100)
          } else if (snr > 2) {
            return "#fef9c3"; // Light yellow (Yellow 100)
          } else {
            return "#fee2e2"; // Light red (Red 100)
          }
        }

        function updateState() {
          if (!currentScenario) return;

          // 1. Gather Inputs
          const heFlow = parseFloat(document.getElementById("he-slider").value);
          const o2Flow = parseFloat(document.getElementById("o2-slider").value);
          const q1Mz = currentScenario.q1Mz;
          const q3Mz = isMSMSMode
            ? parseFloat(document.getElementById("q3-mz").value)
            : q1Mz;

          // Update Tuning UI Labels
          document.getElementById("val-he").textContent =
            heFlow.toFixed(1) + " mL/min";
          document.getElementById("val-o2").textContent =
            o2Flow.toFixed(0) + " %";

          // 2. Calculate Tuning Factors (0.0 to 1.0 attenuation)
          const heStrength = (heFlow / 10) * 0.95;
          const o2Strength = (o2Flow / 100) * 0.99;

          // 3. Process Analyte
          const analyteInit = 1000;
          const analyteMass = currentScenario.analyte.mass;
          let analyteFinal = 0;
          let finalAnalyteMass = analyteMass;

          // Q1 Filter (Assumes Q1 is wide enough for the primary analyte ion)
          if (Math.abs(analyteMass - q1Mz) < 0.2) {
            // Analyte passes Q1

            // Attenuation in CRC
            const attenuatedSignal =
              analyteInit *
              (1 - heStrength * currentScenario.analyte.kedLoss) *
              (1 - o2Strength * currentScenario.analyte.rxnLoss);

            if (isMSMSMode && o2Flow > 0) {
              // MS/MS Mode: Reaction shifts mass to product mass
              finalAnalyteMass =
                analyteMass + currentScenario.analyte.productShift;

              // Q3 Filter: Only measure signal at Q3 set mass
              if (Math.abs(finalAnalyteMass - q3Mz) < 0.2) {
                analyteFinal = attenuatedSignal;
              } else {
                analyteFinal = 0; // Did not react, or Q3 is set incorrectly
              }
            } else {
              // CRC/Q1 Mode: Signal is measured at the original mass (Q3 is set to Q1 mass implicitly)
              finalAnalyteMass = analyteMass;
              analyteFinal = attenuatedSignal;
            }
          } else {
            analyteFinal = 0; // Filtered by Q1
          }

          // 4. Process Interferents
          const processedInterferents = currentScenario.interferents.map(
            (interf, index) => {
              const slider = document.getElementById(`interf-slider-${index}`);
              const initCounts = parseFloat(slider.value);
              const interfMass = interf.mass;
              let finalCounts = 0;
              let finalInterfMass = interfMass;

              // Q1 Filter: Only ions near Q1 mass enter CRC
              if (Math.abs(interfMass - q1Mz) < 0.2) {
                // Interferent passes Q1

                // Attenuation in CRC
                const attenuatedSignal =
                  initCounts *
                  (1 - heStrength * interf.kedFactor) *
                  (1 - o2Strength * interf.reactionFactor);

                if (isMSMSMode && o2Flow > 0) {
                  // MS/MS Mode: Check if interferent is inert (most polyatomics are)
                  finalInterfMass = interfMass + interf.productShift;

                  // Q3 Filter: Check if the *final* mass matches Q3 mass
                  if (Math.abs(finalInterfMass - q3Mz) < 0.2) {
                    finalCounts = attenuatedSignal;
                  } else {
                    finalCounts = 0; // Filtered by Q3
                  }
                } else {
                  // CRC/Q1 Mode: Measured at original mass
                  finalInterfMass = interfMass;
                  finalCounts = attenuatedSignal;
                }
              } else {
                finalCounts = 0; // Filtered by Q1
              }

              return {
                ...interf,
                finalCounts: finalCounts,
                finalMass: finalInterfMass,
                color: colors.interferents[index % colors.interferents.length],
              };
            }
          );

          // 5. Render
          const data = {
            analyte: {
              ...currentScenario.analyte,
              finalCounts: analyteFinal,
              finalMass: finalAnalyteMass,
            },
            interferents: processedInterferents,
          };

          drawChart(data, q3Mz);
          updateTable(data);
          updateStatus(data);
        }

        function drawChart(data, centerMz) {
          // Determine chart center
          const mzCenter = isMSMSMode ? centerMz : data.analyte.mass;
          document.getElementById("chart-range").textContent =
            `Mass Range: ${(mzCenter - 0.8).toFixed(1)} to ${(mzCenter + 0.8).toFixed(1)}`;

          const totalSignal =
            data.analyte.finalCounts +
            data.interferents.reduce((sum, i) => sum + i.finalCounts, 0);

          // X Scale (Centered on the measurement mass, which is Q1 in CRC or Q3 in MS/MS)
          x.domain([mzCenter - 0.8, mzCenter + 0.8]);

          // Y Scale (Dynamic max)
          const maxPeak = Math.max(
            data.analyte.finalCounts,
            ...data.interferents.map((i) => i.finalCounts)
          );
          y.domain([0, Math.max(100, maxPeak * 1.2)]);

          g.selectAll("*").remove();

          // 0. Add Dynamic Status Background to Chart
          const statusColor = getStatusColor(data);

          // (previous code continues here)

          g.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", width)
            .attr("height", height)
            .attr("fill", statusColor)
            .attr("opacity", 0.05); // Kept the gentle shade (0.05)

          // Gridlines
          const makeYGrid = () => d3.axisLeft(y).ticks(5);
          g.append("g")
            .attr("class", "grid-line")
            .call(makeYGrid().tickSize(-width).tickFormat(""));

          // Axes
          g.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).ticks(5));
          g.append("g").call(
            d3.axisLeft(y).ticks(5).tickFormat(d3.format(".2s"))
          );

          // Labels
          g.append("text")
            .attr("text-anchor", "end")
            .attr("x", width)
            .attr("y", height - 6)
            .attr("class", "axis-label")
            .text("Mass/Charge (m/z)");

          // Gaussian Generator
          const getGaussian = (mass, height) => {
            const points = [];
            const range = 1.0;
            // Only draw the peak if it falls within the current chart range
            if (mass < mzCenter - range || mass > mzCenter + range)
              return points;

            for (let m = mass - range; m <= mass + range; m += 0.05) {
              const yVal =
                height *
                Math.exp(-0.5 * Math.pow((m - mass) / resolution_sigma, 2));
              points.push({ mz: m, intensity: yVal });
            }
            return points;
          };

          // 1. Draw Interferents (Area first, then Line on top)
          data.interferents.forEach((interf) => {
            const pathData = getGaussian(interf.finalMass, interf.finalCounts);
            if (pathData.length > 0) {
              // Draw AREA (Shaded fill)
              g.append("path")
                .datum(pathData)
                .attr("class", "peak-area")
                .style("fill", interf.color) // Use interferent color for fill
                .style("fill-opacity", 0.25)
                .attr("stroke", "none")
                .attr("d", area); // Use d3.area generator

              // Draw LINE (Outline)
              g.append("path")
                .datum(pathData)
                .attr("class", "peak-line")
                .attr("fill", "none")
                .attr("stroke", interf.color)
                .attr("d", line);
            }
          });

          // 2. Draw Analyte (Area first, then Line on top, ensures it is visible)
          const analyteData = getGaussian(
            data.analyte.finalMass,
            data.analyte.finalCounts
          );
          if (analyteData.length > 0) {
            // Draw AREA (Shaded fill)
            g.append("path")
              .datum(analyteData)
              .attr("class", "peak-area")
              .style("fill", colors.analyte)
              .style("fill-opacity", 0.28)
              .attr("stroke", "none") // Use analyte color for fill
              .attr("d", area); // Use d3.area generator

            // Draw LINE (Outline)
            g.append("path")
              .datum(analyteData)
              .attr("class", "peak-line")
              .style("fill", "none")
              .attr("stroke", colors.analyte)
              .attr("d", line);

            // 3. Draw Analyte Center Line and Label
            const centerText = isMSMSMode
              ? `${data.analyte.name.split("+")[0]}O`
              : data.analyte.name.split("+")[0];

            g.append("line")
              .attr("x1", x(data.analyte.finalMass))
              .attr("x2", x(data.analyte.finalMass))
              .attr("y1", y(data.analyte.finalCounts))
              .attr("y2", height)
              .attr("stroke", colors.analyte)
              .attr("stroke-width", 1.5)
              .attr("stroke-dasharray", "3,3");

            g.append("text")
              .attr("x", x(data.analyte.finalMass))
              .attr("y", y(data.analyte.finalCounts) - 10)
              .attr("text-anchor", "middle")
              .attr("font-size", "14px")
              .attr("font-weight", "bold")
              .attr("fill", colors.analyte)
              .text(centerText);
          }

          // 4. Draw Total Signal (Dashed line at center mass)
          // Only draw total signal line if it's within the chart range
          if (Math.abs(mzCenter - mzCenter) < 0.8) {
            g.append("line")
              .attr("x1", x(mzCenter))
              .attr("x2", x(mzCenter))
              .attr("y1", height)
              .attr("y2", y(totalSignal))
              .attr("stroke", colors.total)
              .attr("stroke-width", 2)
              .attr("stroke-dasharray", "4,4");

            // Total Dot
            g.append("circle")
              .attr("cx", x(mzCenter))
              .attr("cy", y(totalSignal))
              .attr("r", 4)
              .attr("fill", colors.total);
          }
        }

        function updateTable(data) {
          const tbody = document.getElementById("table-body");
          tbody.innerHTML = "";

          const total =
            data.analyte.finalCounts +
            data.interferents.reduce((a, b) => a + b.finalCounts, 0);

          // Helper
          const addRow = (name, counts, finalMass, cssClass, badge = "") => {
            const row = document.createElement("tr");
            const pct = total > 0 ? ((counts / total) * 100).toFixed(1) : "0.0";

            // Determine measured mass text
            const massText = finalMass ? ` @ ${finalMass.toFixed(2)}` : "";

            row.innerHTML = `
                    <td>
                        <span class="${cssClass} font-bold">${name}</span>${massText}
                        ${badge}
                    </td>
                    <td class="text-right font-mono">${d3.format(",.0f")(counts)}</td>
                    <td class="text-right font-mono">${pct}%</td>
                `;
            tbody.appendChild(row);
          };

          // Analyte
          const analyteName =
            isMSMSMode && data.analyte.finalMass > data.analyte.mass
              ? `${data.analyte.name.split("+")[0]}O+ (Product)`
              : data.analyte.name;

          addRow(
            analyteName,
            data.analyte.finalCounts,
            data.analyte.finalMass,
            "text-emerald-600",
            `<span class="status-badge bg-emerald-100 text-emerald-700 ml-2">Analyte</span>`
          );

          // Interferents
          data.interferents.forEach((interf) => {
            addRow(
              interf.name,
              interf.finalCounts,
              interf.finalMass,
              "",
              `<span class="status-badge bg-orange-100 text-orange-700 ml-2" style="color:${interf.color}">Interference</span>`
            );
          });

          // Total
          const totalRow = document.createElement("tr");
          totalRow.innerHTML = `
                <td>Total Measured Signal</td>
                <td class="text-right font-mono text-blue-600">${d3.format(",.0f")(total)}</td>
                <td class="text-right font-mono text-blue-600">100%</td>
            `;
          tbody.appendChild(totalRow);
        }

        function updateStatus(data) {
          const box = document.getElementById("status-message");
          const totalInterf = data.interferents.reduce(
            (a, b) => a + b.finalCounts,
            0
          );
          const analyte = data.analyte.finalCounts;
          const snr = analyte / (totalInterf + 1); // Avoid div by zero

          let modeSpecificNote = "";
          if (isMSMSMode) {
            modeSpecificNote = ` (Q3 set to ${document.getElementById("q3-mz").value})`;
          }

          if (snr > 20) {
            box.innerHTML = `<span class="text-emerald-600"><i class="fa-solid fa-check-circle"></i> Excellent Separation${modeSpecificNote}.</span> High purity analyte signal. Quantitative results are reliable.`;
          } else if (snr > 2) {
            box.innerHTML = `<span class="text-amber-600"><i class="fa-solid fa-triangle-exclamation"></i> Marginal Interference${modeSpecificNote}.</span> Result may be biased. Optimize tuning further.`;
          } else {
            box.innerHTML = `<span class="text-red-600"><i class="fa-solid fa-circle-xmark"></i> Severe Overlap${modeSpecificNote}.</span> Signal is dominated by interference. Results are invalid.`;
          }
        }

        function renderInterferentControls() {
          const container = document.getElementById("composition-controls");
          container.innerHTML = ""; // Clear

          // 1. Analyte Control (Fixed Trace)
          const analyteDiv = document.createElement("div");
          analyteDiv.className =
            "mb-4 pb-4 border-b border-orange-200 last:border-0";
          analyteDiv.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Analyte: ${currentScenario.analyte.name}</label>
                    <span class="font-mono text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded">1,000 cps (Fixed)</span>
                </div>
            `;
          container.appendChild(analyteDiv);

          // 2. Interferent Controls (Dynamic)
          currentScenario.interferents.forEach((interf, index) => {
            const wrapper = document.createElement("div");
            wrapper.className =
              "mb-4 pb-4 border-b border-orange-200 last:border-0 last:pb-0 last:mb-0";

            const id = `interf-slider-${index}`;
            const color =
              colors.interferents[index % colors.interferents.length];

            wrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-slate-600 uppercase tracking-wide">
                            <span style="color:${color}">●</span> ${interf.name}
                        </label>
                        <span id="val-${id}" class="font-mono text-xs font-bold text-slate-600 bg-white px-2 py-0.5 rounded border border-slate-200">
                            ${d3.format(",")(interf.default)} cps
                        </span>
                    </div>
                    <input type="range" id="${id}" class="slider-interf-${index % 2}" min="0" max="1000000" step="1000" value="${interf.default}">
                `;
            container.appendChild(wrapper);

            // Add listener immediately
            wrapper.querySelector("input").addEventListener("input", (e) => {
              document.getElementById(`val-${id}`).textContent =
                d3.format(",")(e.target.value) + " cps";
              updateState();
            });
          });
        }

        // Init
        window.addEventListener("load", init);
      })();
    </script>
  </body>
</html>
